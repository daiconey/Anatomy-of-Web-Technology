import React, { useState, useEffect } from 'react';
import { Layers, Palette, Zap, Image, MousePointer2, Check, Smile, Flower, Fish, Bot } from 'lucide-react';

const WebAnatomy = () => {
  // 各技術の有効/無効状態を管理
  const [layers, setLayers] = useState({
    css: true,
    svg: true,
    js: true,
  });

  // JSによる状態管理
  const [mood, setMood] = useState('normal');
  const [clickCount, setClickCount] = useState(0);
  const [isBlinking, setIsBlinking] = useState(false);
  
  // テーマ管理
  const [currentThemeId, setCurrentThemeId] = useState('classic');
  
  // モデル（被写体）管理: 'robot', 'bear', 'flower', 'fish'
  const [subject, setSubject] = useState('robot');

  // テーマ定義
  const themes = {
    classic: {
      name: "Classic",
      bg: "bg-slate-800",
      bgHappy: "bg-indigo-600",
      accent: "bg-blue-600",
      accentDark: "bg-blue-700",
      contrast: "bg-slate-400",
      svgColor: "text-blue-500",
      textColor: "text-slate-800",
      containerBorder: "border-slate-800",
      font: "font-sans",
      rounded: "rounded-2xl"
    },
    cyber: {
      name: "Cyber",
      bg: "bg-zinc-900 border-2 border-green-500 shadow-[0_0_20px_rgba(34,197,94,0.3)]",
      bgHappy: "bg-zinc-800 border-2 border-green-400",
      accent: "bg-green-700 border border-green-400",
      accentDark: "bg-green-600",
      contrast: "bg-green-600",
      svgColor: "text-green-500",
      textColor: "text-green-600",
      containerBorder: "border-zinc-900",
      font: "font-mono",
      rounded: "rounded-sm"
    },
    nature: {
      name: "Nature",
      bg: "bg-stone-600",
      bgHappy: "bg-emerald-600",
      accent: "bg-emerald-600",
      accentDark: "bg-emerald-700",
      contrast: "bg-stone-400",
      svgColor: "text-emerald-300",
      textColor: "text-stone-800",
      containerBorder: "border-stone-700",
      font: "font-sans",
      rounded: "rounded-[2rem]"
    },
    sunset: {
      name: "Sunset",
      bg: "bg-orange-600",
      bgHappy: "bg-rose-600",
      accent: "bg-orange-500",
      accentDark: "bg-orange-600",
      contrast: "bg-orange-300",
      svgColor: "text-yellow-200",
      textColor: "text-orange-900",
      containerBorder: "border-orange-800",
      font: "font-serif",
      rounded: "rounded-xl"
    },
    royal: {
      name: "Royal",
      bg: "bg-purple-900 border-4 border-yellow-500",
      bgHappy: "bg-fuchsia-800 border-4 border-yellow-400",
      accent: "bg-purple-700 border border-yellow-500",
      accentDark: "bg-purple-800",
      contrast: "bg-yellow-500",
      svgColor: "text-yellow-400",
      textColor: "text-purple-900",
      containerBorder: "border-purple-950",
      font: "font-sans",
      rounded: "rounded-lg"
    }
  };

  const currentTheme = themes[currentThemeId];

  // JSレイヤーがオフになったら状態をリセット
  useEffect(() => {
    if (!layers.js) {
      setMood('normal');
      setClickCount(0);
      setIsBlinking(false);
    }
  }, [layers.js]);

  // まばたき制御（JS有効時のみ）
  useEffect(() => {
    if (!layers.js) return;

    let blinkTimeout;
    const blinkLoop = () => {
      setIsBlinking(true);
      setTimeout(() => setIsBlinking(false), 200); 
      const nextBlinkTime = Math.random() * 4000 + 2000;
      blinkTimeout = setTimeout(blinkLoop, nextBlinkTime);
    };

    blinkTimeout = setTimeout(blinkLoop, 3000);
    return () => clearTimeout(blinkTimeout);
  }, [layers.js]);

  // トグルスイッチのハンドラー
  const toggleLayer = (layer) => {
    setLayers(prev => ({ ...prev, [layer]: !prev[layer] }));
  };

  // クリック時のハンドラー
  const handleObjectClick = () => {
    if (!layers.js) return;
    
    setClickCount(prev => prev + 1);
    setMood(prev => prev === 'normal' ? 'happy' : 'normal');
    
    setIsBlinking(true);
    setTimeout(() => setIsBlinking(false), 200);
  };

  // --- MODEL RENDERERS ---

  // 1. Robot Renderer (DOMくん)
  const renderRobot = () => (
    <div 
      className={`
        ${layers.css ? `w-40 h-40 relative flex flex-col items-center justify-center transition-all duration-500 ${currentTheme.rounded}` : ''}
        ${layers.css ? (mood === 'happy' ? currentTheme.bgHappy : currentTheme.bg) : ''}
      `}
      style={!layers.css ? { border: '1px solid black', padding: '10px', margin: '10px 0' } : {}}
    >
      {/* アンテナ */}
      {layers.css && (
        <div className={`absolute -top-6 w-2 h-6 origin-bottom ${currentTheme.contrast} ${layers.js ? 'animate-swing' : ''}`}>
          <div className={`absolute -top-3 -left-1.5 w-5 h-5 rounded-full ${mood === 'happy' ? 'bg-yellow-400' : 'bg-red-500'} border-2 border-white relative`}>
            {layers.js && (
              <span className="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75 animate-ping"></span>
            )}
          </div>
        </div>
      )}

      {/* 目 */}
      <div className={layers.css ? 'flex gap-6 mb-4 items-center h-12' : ''}>
        <div className={`${layers.css ? `w-10 bg-white flex items-center justify-center overflow-hidden transition-all duration-100 ${currentTheme.rounded === 'rounded-sm' ? 'rounded-sm' : 'rounded-full'}` : ''} ${layers.css ? (isBlinking ? 'h-1' : 'h-10') : ''}`}>
          {layers.css ? <div className={`w-3 h-3 bg-black rounded-full ${layers.js && mood === 'happy' ? 'scale-150' : ''}`}></div> : <span>[左目]</span>}
        </div>
        <div className={`${layers.css ? `w-10 bg-white flex items-center justify-center overflow-hidden transition-all duration-100 ${currentTheme.rounded === 'rounded-sm' ? 'rounded-sm' : 'rounded-full'}` : ''} ${layers.css ? (isBlinking ? 'h-1' : 'h-10') : ''}`}>
          {layers.css ? <div className={`w-3 h-3 bg-black rounded-full ${layers.js && mood === 'happy' ? 'scale-150' : ''}`}></div> : <span>[右目]</span>}
        </div>
      </div>

      {/* 口 */}
      {layers.css ? (
        <div className={`w-16 h-4 bg-slate-600 rounded-full transition-all duration-300 ${mood === 'happy' ? 'h-8 rounded-b-full bg-red-400' : ''}`}></div>
      ) : (
        <div>[口]</div>
      )}

      {/* SVG: ロゴバッジ */}
      <div className={layers.css ? 'absolute -bottom-5 w-12 h-12 bg-white rounded-full border-4 border-slate-200 flex items-center justify-center shadow-md' : ''}>
        {layers.svg ? (
          <svg viewBox="0 0 24 24" className={`w-8 h-8 ${currentTheme.svgColor} ${layers.js ? 'animate-[spin_10s_linear_infinite]' : ''}`} fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="12" cy="12" r="3" />
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
          </svg>
        ) : (
          <span className="text-[10px] text-slate-400 font-mono">SVG</span>
        )}
      </div>
    </div>
  );

  // 2. Bear Renderer (クマ)
  const renderBear = () => (
    <div 
      className={`
        ${layers.css ? `w-40 h-36 relative flex flex-col items-center justify-center transition-all duration-500 rounded-[3rem_3rem_2rem_2rem]` : ''}
        ${layers.css ? (mood === 'happy' ? currentTheme.bgHappy : currentTheme.bg) : ''}
      `}
      style={!layers.css ? { border: '1px solid brown', padding: '10px' } : {}}
    >
      {/* 耳 */}
      {layers.css && (
        <>
          <div className={`absolute -top-4 -left-2 w-14 h-14 rounded-full ${mood === 'happy' ? currentTheme.bgHappy : currentTheme.bg} ${layers.js ? 'animate-pulse' : ''}`}></div>
          <div className={`absolute -top-4 -right-2 w-14 h-14 rounded-full ${mood === 'happy' ? currentTheme.bgHappy : currentTheme.bg} ${layers.js ? 'animate-pulse' : ''}`}></div>
        </>
      )}

      {/* 目 */}
      <div className={layers.css ? 'relative z-10 flex gap-8 mb-2 items-center h-12 mt-4' : ''}>
        <div className={`${layers.css ? 'w-4 h-4 bg-white rounded-full' : ''} ${layers.css ? (isBlinking ? 'h-1' : 'h-4') : ''}`}>
           {!layers.css && <span>[目]</span>}
        </div>
        <div className={`${layers.css ? 'w-4 h-4 bg-white rounded-full' : ''} ${layers.css ? (isBlinking ? 'h-1' : 'h-4') : ''}`}>
           {!layers.css && <span>[目]</span>}
        </div>
      </div>

      {/* 口・鼻周り */}
      <div className={layers.css ? 'relative z-10 w-20 h-14 bg-white/20 rounded-full flex flex-col items-center justify-center' : ''}>
         {layers.css ? (
           <>
             <div className="w-8 h-6 bg-slate-900 rounded-full mb-1"></div>
             <div className={`w-1 h-3 bg-slate-900`}></div>
             <div className={`w-10 h-1 bg-slate-900 rounded-full ${mood === 'happy' ? 'w-12 h-4 rounded-b-full' : ''}`}></div>
           </>
         ) : (
           <div>[鼻・口]</div>
         )}
      </div>

      {/* SVG: 蝶ネクタイ */}
      <div className={layers.css ? 'absolute -bottom-4 z-20 drop-shadow-md' : ''}>
        {layers.svg ? (
          <svg width="50" height="25" viewBox="0 0 60 30" className={`${currentTheme.svgColor} fill-current`}>
            <path d="M30 15 L0 0 V30 L30 15 L60 0 V30 Z" />
          </svg>
        ) : (
           !layers.css && <span>[Ribbon]</span>
        )}
      </div>
    </div>
  );

  // 3. Flower Renderer (お花)
  const renderFlower = () => (
    <div className="relative flex flex-col items-center justify-center">
      {/* 花びら */}
      {layers.css && (
        <div className={`absolute w-56 h-56 ${layers.js ? 'animate-[spin_10s_linear_infinite]' : ''}`}>
          {[...Array(8)].map((_, i) => (
            <div 
              key={i}
              className={`absolute w-14 h-14 rounded-full opacity-90 ${currentTheme.accent}`}
              style={{
                top: '50%', left: '50%',
                transform: `translate(-50%, -50%) rotate(${i * 45}deg) translate(0, -60px)`
              }}
            ></div>
          ))}
        </div>
      )}
      {!layers.css && <div>[花びらx8]</div>}

      {/* 花の中心 (顔) */}
      <div 
        className={`
          ${layers.css ? 'w-28 h-28 relative z-10 rounded-full flex flex-col items-center justify-center shadow-lg' : ''}
          ${layers.css ? (mood === 'happy' ? currentTheme.bgHappy : currentTheme.bg) : ''}
        `}
        style={!layers.css ? { border: '1px dashed green', padding: '10px' } : {}}
      >
        {/* 目 */}
        <div className={layers.css ? 'flex gap-4 mb-2' : ''}>
           <div className={`${layers.css ? 'w-3 h-8 bg-slate-800 rounded-full' : ''} ${layers.css ? (isBlinking ? 'scale-y-10' : '') : ''}`}>
             {!layers.css && <span>[目]</span>}
           </div>
           <div className={`${layers.css ? 'w-3 h-8 bg-slate-800 rounded-full' : ''} ${layers.css ? (isBlinking ? 'scale-y-10' : '') : ''}`}>
             {!layers.css && <span>[目]</span>}
           </div>
        </div>
        {/* 口 */}
        {layers.css ? (
          <div className={`w-8 h-4 border-b-4 border-slate-800 rounded-full ${mood === 'happy' ? 'h-6 w-10' : ''}`}></div>
        ) : (
          <div>[口]</div>
        )}
      </div>

      {/* 茎 */}
      {layers.css ? (
        <div className={`w-4 h-20 mt-0 ${currentTheme.contrast} relative`}>
           {/* 葉っぱ (SVG) */}
           {layers.svg && (
             <svg className={`absolute top-4 -right-8 w-10 h-10 text-green-500 fill-current ${layers.js ? 'animate-bounce' : ''}`} viewBox="0 0 24 24">
               <path d="M2,12 Q12,2 22,12 Q12,22 2,12" />
             </svg>
           )}
        </div>
      ) : (
        <div>
          <div>[茎]</div>
          {layers.svg && <div>[葉っぱ(SVG)]</div>}
        </div>
      )}
    </div>
  );

  // 4. Fish Renderer (魚)
  const renderFish = () => (
    <div className="relative w-full flex justify-center items-center py-6">
      <div 
        className={`
          ${layers.css ? 'relative w-48 h-28 rounded-[50%] flex items-center justify-center transition-transform duration-1000' : ''}
          ${layers.css ? (mood === 'happy' ? currentTheme.bgHappy : currentTheme.bg) : ''}
          ${layers.css && layers.js ? 'animate-[pulse_3s_ease-in-out_infinite]' : ''}
        `}
        style={!layers.css ? { border: '1px solid blue', padding: '10px' } : {}}
      >
        {/* 尾ひれ */}
        {layers.css && (
          <div 
            className={`absolute -right-6 w-14 h-14 rounded-r-lg ${mood === 'happy' ? currentTheme.bgHappy : currentTheme.bg}`}
            style={{ clipPath: 'polygon(0 50%, 100% 0, 100% 100%)' }}
          ></div>
        )}
        {!layers.css && <span>[尾ひれ]</span>}

        {/* ヒレ */}
        {layers.css && (
          <div className={`absolute -top-5 w-10 h-7 rounded-t-full ${currentTheme.accent}`}></div>
        )}

        {/* 目 */}
        <div className={layers.css ? 'absolute left-8 -top-2 flex flex-col items-center' : ''}>
           <div className={`
             ${layers.css ? 'w-8 h-8 bg-white rounded-full flex items-center justify-center border-4 border-black/10' : ''}
             ${layers.css && isBlinking ? 'scale-y-0' : ''}
           `}>
             {layers.css ? <div className="w-3 h-3 bg-black rounded-full ml-1.5"></div> : <span>[目]</span>}
           </div>
        </div>

        {/* エラ・模様 */}
        {layers.css && (
          <div className="absolute right-14 flex flex-col gap-2 opacity-30">
            <div className="w-1 h-10 bg-black rounded-full"></div>
            <div className="w-1 h-8 bg-black rounded-full"></div>
          </div>
        )}

        {/* 口 */}
        {layers.css && (
          <div className="absolute -left-1 top-14 w-5 h-2 bg-black/30 rounded-full"></div>
        )}

        {/* SVG: 泡 */}
        {layers.svg && (
          <div className="absolute -left-10 -top-8 flex flex-col gap-2">
            <svg className={`w-5 h-5 text-blue-300 ${layers.js ? 'animate-bounce' : ''}`} viewBox="0 0 24 24" fill="currentColor">
               <circle cx="12" cy="12" r="10" opacity="0.6"/>
            </svg>
            <svg className={`w-3 h-3 text-blue-300 ml-4 ${layers.js ? 'animate-ping' : ''}`} viewBox="0 0 24 24" fill="currentColor">
               <circle cx="12" cy="12" r="10" opacity="0.4"/>
            </svg>
          </div>
        )}
        {!layers.css && layers.svg && <div>[泡(SVG)]</div>}

      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans p-2 flex flex-col overflow-hidden">
      <style>{`
        @keyframes swing {
          0%, 100% { transform: rotate(-10deg); }
          50% { transform: rotate(10deg); }
        }
        .animate-swing {
          animation: swing 2s ease-in-out infinite;
          transform-origin: bottom center;
        }
      `}</style>

      <div className="w-full max-w-5xl mx-auto h-full flex flex-col">
        <header className="mb-2 text-center shrink-0">
          <h1 className="text-xl md:text-2xl font-bold text-slate-900">Web技術の解剖図鑑</h1>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-3 items-start grow min-h-0">
          
          {/* 左カラム：コントロール */}
          <div className="bg-white rounded-xl shadow-lg p-3 space-y-2 lg:col-span-1 border border-slate-100 h-full flex flex-col overflow-y-auto">
            <h2 className="text-md font-bold flex items-center gap-2 pb-2 border-b border-slate-100 shrink-0">
              <Layers className="w-4 h-4 text-blue-500" />
              構成レイヤー制御
            </h2>

            {/* Controls */}
            <div className="space-y-2 grow">
              {/* HTML */}
              <div className="flex items-center justify-between p-2 bg-slate-100 rounded-lg border border-slate-200 cursor-not-allowed">
                <div className="flex items-center gap-2">
                  <div className="p-1.5 bg-orange-100 text-orange-600 rounded-md"><span className="font-bold text-xs">HTML</span></div>
                  <div>
                    <div className="font-bold text-xs text-slate-700">構造・骨格</div>
                  </div>
                </div>
                <div className="w-8 h-5 bg-green-500 rounded-full opacity-50 relative">
                  <div className="absolute right-1 top-1 w-3 h-3 bg-white rounded-full"></div>
                </div>
              </div>

              {/* CSS Toggle */}
              <button onClick={() => toggleLayer('css')} className={`w-full flex items-center justify-between p-2 rounded-lg border transition-all ${layers.css ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-200'}`}>
                 <div className="flex items-center gap-2">
                   <div className={`p-1.5 rounded-md ${layers.css ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-400'}`}><Palette size={16} /></div>
                   <div className="text-left">
                     <div className="font-bold text-xs text-slate-700">CSS (見た目)</div>
                   </div>
                 </div>
                 <div className={`w-10 h-6 rounded-full relative transition-colors ${layers.css ? 'bg-blue-500' : 'bg-slate-300'}`}>
                   <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${layers.css ? 'translate-x-5' : 'translate-x-1'}`}></div>
                 </div>
              </button>

              {/* SVG Toggle */}
              <button onClick={() => toggleLayer('svg')} className={`w-full flex items-center justify-between p-2 rounded-lg border transition-all ${layers.svg ? 'bg-pink-50 border-pink-200' : 'bg-white border-slate-200'}`}>
                 <div className="flex items-center gap-2">
                   <div className={`p-1.5 rounded-md ${layers.svg ? 'bg-pink-500 text-white' : 'bg-slate-200 text-slate-400'}`}><Image size={16} /></div>
                   <div className="text-left">
                     <div className="font-bold text-xs text-slate-700">SVG (画像)</div>
                   </div>
                 </div>
                 <div className={`w-10 h-6 rounded-full relative transition-colors ${layers.svg ? 'bg-pink-500' : 'bg-slate-300'}`}>
                   <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${layers.svg ? 'translate-x-5' : 'translate-x-1'}`}></div>
                 </div>
              </button>

              {/* JS Toggle */}
              <button onClick={() => toggleLayer('js')} className={`w-full flex items-center justify-between p-2 rounded-lg border transition-all ${layers.js ? 'bg-yellow-50 border-yellow-200' : 'bg-white border-slate-200'}`}>
                 <div className="flex items-center gap-2">
                   <div className={`p-1.5 rounded-md ${layers.js ? 'bg-yellow-500 text-white' : 'bg-slate-200 text-slate-400'}`}><Zap size={16} /></div>
                   <div className="text-left">
                     <div className="font-bold text-xs text-slate-700">JS (動作)</div>
                   </div>
                 </div>
                 <div className={`w-10 h-6 rounded-full relative transition-colors ${layers.js ? 'bg-yellow-500' : 'bg-slate-300'}`}>
                   <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${layers.js ? 'translate-x-5' : 'translate-x-1'}`}></div>
                 </div>
              </button>
            </div>
          </div>

          {/* 右カラム：プレビュー */}
          <div className="lg:col-span-2 flex flex-col gap-3 h-full">
            
            {/* 上部コントロールバー */}
            <div className="bg-white p-2 rounded-xl shadow-sm border border-slate-200 shrink-0">
               {/* モデル選択 */}
               <div className="flex items-center justify-center gap-2 border-b border-slate-100 pb-2 mb-2">
                  <span className="text-[10px] font-bold text-slate-500 uppercase">MODEL</span>
                  <div className="flex gap-1">
                    <button onClick={() => setSubject('robot')} className={`p-1.5 rounded-lg flex items-center gap-1 transition-all ${subject === 'robot' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                      <Bot size={14} />
                    </button>
                    <button onClick={() => setSubject('bear')} className={`p-1.5 rounded-lg flex items-center gap-1 transition-all ${subject === 'bear' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                      <Smile size={14} />
                    </button>
                    <button onClick={() => setSubject('flower')} className={`p-1.5 rounded-lg flex items-center gap-1 transition-all ${subject === 'flower' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                      <Flower size={14} />
                    </button>
                    <button onClick={() => setSubject('fish')} className={`p-1.5 rounded-lg flex items-center gap-1 transition-all ${subject === 'fish' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                      <Fish size={14} />
                    </button>
                  </div>
               </div>

               {/* テーマ選択 */}
               {layers.css && (
                 <div className="flex items-center justify-center gap-2">
                    <span className="text-[10px] font-bold text-slate-500 uppercase">THEME</span>
                    <div className="flex flex-wrap gap-1 justify-center">
                      {Object.keys(themes).map((id) => (
                        <button
                          key={id}
                          onClick={() => setCurrentThemeId(id)}
                          className={`px-2 py-1 rounded-md text-[10px] font-medium transition-all flex items-center gap-1 ${currentThemeId === id ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}
                        >
                          {themes[id].name}
                          {currentThemeId === id && <Check size={10} />}
                        </button>
                      ))}
                    </div>
                 </div>
               )}
            </div>

            {/* ビューポート */}
            <div className="bg-slate-200 rounded-2xl p-4 flex items-center justify-center relative overflow-hidden shadow-inner border border-slate-300 grow min-h-0">
              <div className="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-1 rounded-full text-[10px] font-mono text-slate-500 border border-slate-200 shadow-sm z-10">
                Preview
              </div>

              {/* メインキャラクターコンテナ */}
              <div 
                onClick={handleObjectClick}
                className={`
                  transition-all duration-500
                  ${layers.css 
                    ? `relative bg-white p-4 shadow-xl w-full max-w-sm transform hover:scale-[1.01] cursor-pointer border-4 ${currentTheme.containerBorder} ${currentTheme.rounded}`
                    : 'w-full max-w-sm bg-transparent p-0'
                  }
                `}
              >
                {!layers.css && (
                  <div className="mb-2 p-1.5 bg-orange-100 text-orange-800 text-[10px] border border-orange-200 rounded">
                    ⚠️ CSS無効: 標準スタイルのみ
                  </div>
                )}

                {/* ヘッダー */}
                <header className={layers.css ? `text-center mb-4 border-b border-slate-100 pb-2 ${currentTheme.font}` : ''}>
                  <h2 className={layers.css ? `text-xl font-black ${currentTheme.textColor} tracking-tight uppercase` : ''}>
                    {subject} Mode
                  </h2>
                </header>

                {/* ボディ */}
                <div className={layers.css ? 'flex justify-center mb-4 min-h-[160px] items-center' : ''}>
                   {subject === 'robot' && renderRobot()}
                   {subject === 'bear' && renderBear()}
                   {subject === 'flower' && renderFlower()}
                   {subject === 'fish' && renderFish()}
                </div>

                {/* ステータス & ボタン */}
                <div className="flex items-center justify-between gap-2 border-t border-slate-100 pt-3 mt-3">
                  <div className={layers.css ? 'text-left' : ''}>
                    <p className={layers.css ? 'text-[10px] text-slate-400 uppercase font-bold' : ''}>STATUS</p>
                    <p className={layers.css ? `font-mono text-sm font-bold text-slate-700` : ''}>
                      {layers.js ? (mood === 'normal' ? 'ONLINE' : 'HAPPY!') : 'STATIC'}
                    </p>
                  </div>

                  <button 
                    disabled={!layers.js}
                    className={`
                      ${layers.css 
                        ? `px-4 py-1.5 text-white text-sm font-bold shadow-md active:scale-95 transition-all flex items-center gap-2 ${currentTheme.rounded} ${currentTheme.accent}` 
                        : ''}
                      ${!layers.js && layers.css ? 'opacity-50 cursor-not-allowed bg-slate-400 hover:bg-slate-400 shadow-none border-none' : ''}
                    `}
                  >
                     {layers.css && <MousePointer2 size={14} />}
                     {layers.js ? `Touch` : 'No JS'}
                  </button>
                </div>

              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  );
};

export default WebAnatomy;
